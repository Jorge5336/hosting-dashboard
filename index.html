<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>TOC / Host Dashboard — Carleton</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --blue:#003069; /* Carleton Blue */
      --maize:#FFD24F; /* Maize */
      --bg:#f7f8fb;
      --panel:#ffffff;
      --ink:#0f172a; /* slate-900 */
      --muted:#475569; /* slate-600 */
      --line:#e2e8f0; /* slate-200 */
      --ring: rgba(0,48,105,.35);
      --radius:16px;
      --shadow:0 1px 2px rgba(2,6,23,.06), 0 8px 20px rgba(2,6,23,.08);
    }
    [data-theme="dark"]{
      --bg:#0b1020;
      --panel:#0f162c;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2a44;
      --ring: rgba(255,210,79,.35);
      --shadow:0 1px 2px rgba(0,0,0,.3), 0 8px 20px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; color:var(--ink); background:linear-gradient(180deg, var(--bg), #fff0 60%), var(--bg);}    
    .site-header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, var(--panel), var(--panel));border-bottom:1px solid var(--line);}  
    .site-header .wrap{display:flex;align-items:center;justify-content:space-between;gap:16px;max-width:1100px;margin:0 auto;padding:18px 20px;}
    .brand{display:flex;align-items:center;gap:14px}
    .brand-badge{display:grid;place-items:center;width:40px;height:40px;border-radius:12px;background:var(--blue);color:#fff;font-weight:700;letter-spacing:.5px}
    .brand-title{font-size:1.125rem;line-height:1.1;margin:0}
    .brand-sub{margin:2px 0 0;color:var(--muted);font-size:.875rem}
    .header-actions{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--line);background:var(--panel);padding:8px 12px;border-radius:12px;color:var(--ink);cursor:pointer;box-shadow:var(--shadow);transition:transform .06s ease, box-shadow .2s ease, background .2s ease;}
    .btn:hover{transform:translateY(-1px)}
    .btn:focus-visible{outline:3px solid var(--ring);outline-offset:2px}
    .btn.primary{background:var(--blue);color:#fff;border-color:transparent}
    .btn.subtle{box-shadow:none;border-color:var(--line)}

    /* Tabs */
    .tabs{max-width:1100px;margin:8px auto 0;display:flex;gap:6px;flex-wrap:wrap;padding:0 20px 10px;border-bottom:1px solid var(--line)}
    .tab-btn{appearance:none;border:none;background:none;color:var(--muted);padding:10px 12px;border-radius:10px;cursor:pointer;position:relative;font-weight:600}
    .tab-btn[aria-selected="true"]{color:var(--ink)}
    .tab-btn[aria-selected="true"]::after{content:"";position:absolute;left:10px;right:10px;bottom:-11px;height:3px;background:linear-gradient(90deg, var(--blue), var(--maize));border-radius:3px}

    main{max-width:1100px;margin:18px auto;padding:0 20px 40px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px 14px 16px;box-shadow:var(--shadow)}
    .stat{font-size:2rem;font-weight:800;margin-top:6px}

    .muted{color:var(--muted)}
    .hidden{display:none}

    /* Inputs */
    label{display:flex;flex-direction:column;gap:6px;font-size:.9rem}
    input[type="text"], select{border:1px solid var(--line);background:var(--panel);color:var(--ink);padding:10px 12px;border-radius:12px}
    input[type="file"]{display:none}
    .file{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px dashed var(--line);border-radius:12px;background:linear-gradient(180deg, var(--panel), var(--panel));cursor:pointer}

    /* Chips */
    .chip-row{display:flex;gap:8px;flex-wrap:wrap}
    .chip{appearance:none;border:1px solid var(--line);background:var(--panel);padding:6px 10px;border-radius:999px;cursor:pointer}
    .chip[aria-pressed="true"], .chip.active{background:var(--blue);color:#fff;border-color:transparent}

    /* Tables */
    .table-wrap{flex:1 1 100%;overflow:auto;max-height:60vh}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--panel);z-index:1;border-bottom:1px solid var(--line);text-align:left;font-size:.85rem;padding:10px 12px;color:var(--muted);user-select:none}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--line)}
    tbody tr:hover{background:rgba(0,48,105,.06)}
    th[data-sort]{cursor:pointer}
    th[data-sort] .sort{opacity:.6;margin-left:6px;font-size:.8em}

    /* Empty states */
    .empty{display:flex;align-items:center;gap:10px;color:var(--muted);padding:12px}

    /* Modal */
    dialog{border:none;border-radius:18px;padding:0;background:var(--panel);color:var(--ink);box-shadow:var(--shadow);max-width:560px;width:calc(100% - 24px)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line)}
    .modal-body{padding:18px}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:50}
    .toast .t{background:var(--ink);color:#fff;padding:10px 12px;border-radius:12px;opacity:.98}

    @media (prefers-reduced-motion: no-preference){
      .fade-in{animation:fade .18s ease both}
      @keyframes fade{from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none}}
    }
  </style>
</head>
<body data-theme="light">
  <header class="site-header">
    <div class="wrap">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true">TOC</div>
        <div>
          <h1 class="brand-title">TOC / Host Dashboard</h1>
          <p class="brand-sub">Internal tool for TOC + Hosts. Clean, fast, on-brand.</p>
        </div>
      </div>
      <div class="header-actions">
        <button id="themeToggle" class="btn" title="Toggle theme (T)">Toggle Theme</button>
        <button id="brandBtn" class="btn subtle" title="Brand and access">Brand</button>
      </div>
    </div>
  </header>

  <nav class="tabs" role="tablist" aria-label="Primary">
    <button class="tab-btn" role="tab" aria-selected="true" aria-controls="tab-overview" id="tab-overview-btn">Overview</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-applicants" id="tab-applicants-btn">Applicants</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-hosts" id="tab-hosts-btn">Hosts</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-assignments" id="tab-assignments-btn">Assignments</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-engagement" id="tab-engagement-btn">Attendance / Engagement</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-comms" id="tab-comms-btn">Comms</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-settings" id="tab-settings-btn">Data & Settings</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-tests" id="tab-tests-btn">Tests</button>
  </nav>

  <main>
    <!-- Overview -->
    <section id="tab-overview" role="tabpanel" aria-labelledby="tab-overview-btn">
      <div class="row">
        <div class="card" style="flex:1 1 220px">
          <strong>Total Applicants</strong>
          <div id="ov-applicants" class="stat">0</div>
        </div>
        <div class="card" style="flex:1 1 220px">
          <strong>Total Hosts</strong>
          <div id="ov-hosts" class="stat">0</div>
        </div>
        <div class="card" style="flex:1 1 220px">
          <strong>Assignments</strong>
          <div id="ov-assignments" class="stat">0</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="card" style="flex:1 1 320px">
          <strong>Applicants by State</strong>
          <canvas id="chartByState" height="180" aria-label="Applicants by state"></canvas>
        </div>
        <div class="card" style="flex:1 1 320px">
          <strong>Decision Mix</strong>
          <canvas id="chartDecision" height="180" aria-label="Decision mix"></canvas>
        </div>
        <div class="card" style="flex:1 1 320px">
          <strong>Arrivals by Hour</strong>
          <canvas id="chartArrivals" height="180" aria-label="Arrivals by hour"></canvas>
        </div>
      </div>
      <p class="muted" style="margin-top:12px">Upload CSVs in Data & Settings to populate the dashboard & charts.</p>
    </section>

    <!-- Applicants -->
    <section id="tab-applicants" class="hidden" role="tabpanel" aria-labelledby="tab-applicants-btn">
      <div class="row">
        <div class="card" style="flex:1 1 320px">
          <label>
            <strong>Search</strong>
            <input id="app-search" type="text" placeholder="Search by name, state, or program" aria-label="Search applicants" />
          </label>
          <div class="chip-row" style="margin-top:8px">
            <button class="chip filter" data-filter="all" aria-pressed="true">All</button>
            <button class="chip filter" data-filter="admit" aria-pressed="false">Admits</button>
            <button class="chip filter" data-filter="waitlist" aria-pressed="false">Waitlist</button>
            <button class="chip filter" data-filter="deny" aria-pressed="false">Denies</button>
          </div>
        </div>
      </div>
      <div class="card table-wrap">
        <table id="applicants-table" aria-label="Applicants table">
          <thead>
            <tr>
              <th data-sort="name">Name <span class="sort">▾</span></th>
              <th data-sort="state">State <span class="sort">▾</span></th>
              <th data-sort="program">Program <span class="sort">▾</span></th>
              <th data-sort="decision">Decision <span class="sort">▾</span></th>
              <th data-sort="interest_level">Interest <span class="sort">▾</span></th>
              <th>Flags</th>
            </tr>
          </thead>
          <tbody>
            <tr class="empty"><td colspan="6">No applicants loaded yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Hosts -->
    <section id="tab-hosts" class="hidden" role="tabpanel" aria-labelledby="tab-hosts-btn">
      <div class="card table-wrap">
        <table id="hosts-table" aria-label="Hosts table">
          <thead>
            <tr>
              <th data-sort="name">Host <span class="sort">▾</span></th>
              <th data-sort="building">Building <span class="sort">▾</span></th>
              <th data-sort="room">Room <span class="sort">▾</span></th>
              <th data-sort="capacity">Capacity <span class="sort">▾</span></th>
              <th data-sort="assigned">Assigned <span class="sort">▾</span></th>
              <th data-sort="left">Left <span class="sort">▾</span></th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <tr class="empty"><td colspan="7">No hosts loaded yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Assignments -->
    <section id="tab-assignments" class="hidden" role="tabpanel" aria-labelledby="tab-assignments-btn">
      <div class="row">
        <div class="card" style="flex:1 1 380px">
          <strong>Manual Assignment</strong>
          <label>Applicant
            <select id="as-app"></select>
          </label>
          <label>Host
            <select id="as-host"></select>
          </label>
          <label>Status
            <select id="as-status">
              <option value="assigned">assigned</option>
              <option value="confirmed">confirmed</option>
              <option value="canceled">canceled</option>
              <option value="reassign">reassign</option>
            </select>
          </label>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="as-save" class="btn primary">Save Assignment</button>
            <button id="as-clear" class="btn subtle">Clear All Assignments</button>
          </div>
        </div>
        <div class="card" style="flex:2 1 520px">
          <strong>Auto-Match</strong>
          <p class="muted" style="margin:6px 0 10px">Click “Run Matcher” to pair applicants to hosts based on preferences and constraints. Adjust weights as needed.</p>
          <div class="row">
            <div class="card" style="flex:1 1 220px">
              <label>Weight: Capacity fit <input id="w-capacity" type="range" min="0" max="5" step="1" value="5"></label>
              <label>Weight: Gender/rooming prefs <input id="w-gender" type="range" min="0" max="5" step="1" value="5"></label>
              <label>Weight: Program affinity <input id="w-program" type="range" min="0" max="5" step="1" value="3"></label>
              <label>Weight: Arrival time proximity <input id="w-arrival" type="range" min="0" max="5" step="1" value="2"></label>
              <label>Weight: Quiet/Allergy prefs <input id="w-prefs" type="range" min="0" max="5" step="1" value="4"></label>
            </div>
            <div class="card" style="flex:1 1 220px">
              <label><input id="opt-keep-existing" type="checkbox" checked> Respect existing confirmed assignments</label>
              <label><input id="opt-fair-distribution" type="checkbox" checked> Balance across hosts</label>
              <label><input id="opt-strict-prefs" type="checkbox"> Strictly enforce critical prefs</label>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="run-match" class="btn primary">Run Matcher</button>
            <button id="preview-match" class="btn subtle">Preview Changes</button>
            <button id="apply-match" class="btn subtle" disabled>Apply Suggested Matches</button>
          </div>
          <div id="match-preview" class="muted" style="margin-top:10px"></div>
        </div>
      </div>
      <div class="card table-wrap">
        <table id="assignments-table" aria-label="Assignments">
          <thead>
            <tr>
              <th>Applicant</th>
              <th>Host</th>
              <th>Status</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody>
            <tr class="empty"><td colspan="4">No assignments yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Engagement -->
    <section id="tab-engagement" class="hidden" role="tabpanel" aria-labelledby="tab-engagement-btn">
      <div class="card table-wrap">
        <table id="eng-table" aria-label="Engagement">
          <thead>
            <tr>
              <th>Applicant</th>
              <th>Invite Sent</th>
              <th>Attending</th>
              <th>Checked In</th>
              <th>No Show</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <tr class="empty"><td colspan="6">No engagement data yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Comms -->
    <section id="tab-comms" class="hidden" role="tabpanel" aria-labelledby="tab-comms-btn">
      <div class="card">
        <p class="muted">Upload a communications log CSV with columns: <code>timestamp,recipient,campaign,subject,status,opens,clicks</code>. We'll summarize deliverability + engagement here.</p>
      </div>
      <div id="comms-summary" class="row" style="margin-top:12px"></div>
    </section>

    <!-- Settings -->
    <section id="tab-settings" class="hidden" role="tabpanel" aria-labelledby="tab-settings-btn">
      <div class="row">
        <div class="card"><strong>Load Applicants CSV</strong><br>
          <label class="file"><input id="csv-app" type="file" accept=".csv">Choose file</label>
        </div>
        <div class="card"><strong>Load Hosts CSV</strong><br>
          <label class="file"><input id="csv-host" type="file" accept=".csv">Choose file</label>
        </div>
        <div class="card"><strong>Load Assignments CSV</strong><br>
          <label class="file"><input id="csv-asg" type="file" accept=".csv">Choose file</label>
        </div>
        <div class="card"><strong>Load Engagement CSV</strong><br>
          <label class="file"><input id="csv-eng" type="file" accept=".csv">Choose file</label>
        </div>
        <div class="card"><strong>Load Comms CSV</strong><br>
          <label class="file"><input id="csv-comms" type="file" accept=".csv">Choose file</label>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="card" style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="export-app" class="btn subtle">Export Applicants CSV</button>
          <button id="export-host" class="btn subtle">Export Hosts CSV</button>
          <button id="export-asg" class="btn subtle">Export Assignments CSV</button>
          <button id="export-eng" class="btn subtle">Export Engagement CSV</button>
          <button id="export-comms" class="btn subtle">Export Comms CSV</button>
        </div>
        <div class="card">
          <button id="dl-templates" class="btn">Download CSV Templates</button>
        </div>
      </div>
    </section>

    <!-- Tests -->
    <section id="tab-tests" class="hidden" role="tabpanel" aria-labelledby="tab-tests-btn">
      <div class="card">
        <strong>Self-tests</strong>
        <pre id="test-output" class="muted"></pre>
      </div>
    </section>
  </main>

  <!-- Brand modal -->
  <dialog id="brandModal">
    <div class="modal-head">
      <strong>Brand + Accessibility</strong>
      <button class="btn subtle" id="brandClose">Close</button>
    </div>
    <div class="modal-body">
      <ul>
        <li>Colors use Carleton Blue <code>#003069</code> and Maize <code>#FFD24F</code>.</li>
        <li>Typography prefers Gotham/Surveyor when available; falls back to Inter/system UI.</li>
        <li>Contrast targets WCAG AA for body text. Focus states are visible.</li>
        <li>Keyboard: use Left/Right to move tabs, Enter/Space to select.</li>
      </ul>
    </div>
  </dialog>

  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

  <script>
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    const state = {
      applicants: [],
      hosts: [],
      assignments: [],
      engagement: [],
      comms: [],
      proposedMatches: []
    };

    // Theme toggle
    const themeToggle = $('#themeToggle');
    themeToggle.addEventListener('click', () => toggleTheme());
    document.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='t') toggleTheme();});
    function toggleTheme(){
      const root = document.body;
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      toast(`Theme: ${next}`);
    }

    // Tabs
    const tabButtons = $$('.tab-btn');
    tabButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>activateTab(btn));
      btn.addEventListener('keydown', (e)=>{
        const idx = tabButtons.indexOf(btn);
        if(e.key==='ArrowRight'){ (tabButtons[idx+1]||tabButtons[0]).focus(); }
        if(e.key==='ArrowLeft'){ (tabButtons[idx-1]||tabButtons[tabButtons.length-1]).focus(); }
        if(e.key==='Enter' || e.key===' '){ activateTab(btn); }
      });
    });
    function activateTab(btn){
      tabButtons.forEach(b=>b.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
      $$('main > section').forEach(s=>s.classList.add('hidden'));
      const panel = document.getElementById(btn.getAttribute('aria-controls'));
      panel.classList.remove('hidden');
    }

    // Sort tables
    function sortTable(table, key, dir=1){
      const idx = Array.from(table.tHead.rows[0].cells).findIndex(th=> th.dataset.sort===key);
      if(idx<0) return;
      const rows = Array.from(table.tBodies[0].rows).filter(r=>!r.classList.contains('empty'));
      rows.sort((a,b)=>{
        const va = a.cells[idx].innerText.trim().toLowerCase();
        const vb = b.cells[idx].innerText.trim().toLowerCase();
        return va>vb?dir:va<vb?-dir:0;
      });
      rows.forEach(r=>table.tBodies[0].appendChild(r));
    }
    $$('th[data-sort]').forEach(th=>{
      let dir = 1;
      th.addEventListener('click', ()=>{ dir*=-1; sortTable(th.closest('table'), th.dataset.sort, dir); });
    });

    // Chips filtering (Applicants)
    $$('.chip.filter').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        $$('.chip.filter').forEach(b=>b.setAttribute('aria-pressed','false'));
        ch.setAttribute('aria-pressed','true');
        filterApplicants();
      });
    });
    $('#app-search').addEventListener('input', filterApplicants);

    function filterApplicants(){
      const q = $('#app-search').value.trim().toLowerCase();
      const active = $('.chip.filter[aria-pressed="true"]').dataset.filter;
      const tbody = $('#applicants-table tbody');
      tbody.innerHTML = '';
      const list = state.applicants.filter(a=>{
        const textMatch = !q || [a.name,a.state,a.program].some(v=> (v||'').toLowerCase().includes(q));
        const dec = (a.decision||'').toLowerCase();
        const filterMatch = active==='all' || dec===active;
        return textMatch && filterMatch;
      });
      if(list.length===0){
        tbody.innerHTML = '<tr class="empty"><td colspan="6">No matching applicants.</td></tr>';
        return;
      }
      for(const a of list){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(a.name)}</td>
                        <td>${esc(a.state)}</td>
                        <td>${esc(a.program)}</td>
                        <td>${esc(a.decision)}</td>
                        <td>${esc(a.interest_level||'')}</td>
                        <td>${esc(a.flags||'')}</td>`;
        tbody.appendChild(tr);
      }
    }

    // CSV loading (simple parser; quotes not fully supported)
    const pickers = [
      ['#csv-app','applicants', onApplicantsLoaded],
      ['#csv-host','hosts', onHostsLoaded],
      ['#csv-asg','assignments', onAssignmentsLoaded],
      ['#csv-eng','engagement', onEngagementLoaded],
      ['#csv-comms','comms', onCommsLoaded]
    ];
    pickers.forEach(([sel, key, fn])=>{
      $(sel).addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const text = await file.text();
        const data = csvToObjects(text);
        state[key] = data;
        fn?.(data);
        toast(`${file.name} loaded: ${data.length} rows`);
      });
    });

    function csvToObjects(csv){
      const lines = csv.replace(/\r/g,'').split('\n').filter(Boolean);
      if(lines.length===0) return [];
      const headers = lines[0].split(',').map(h=>h.trim());
      return lines.slice(1).map(line=>{
        const cols = line.split(',');
        const obj = {}; headers.forEach((h,i)=> obj[h] = (cols[i]||'').trim());
        return obj;
      });
    }

    function onApplicantsLoaded(list){
      // Update overview
      $('#ov-applicants').textContent = list.length;
      // Fill table
      const tbody = $('#applicants-table tbody');
      tbody.innerHTML='';
      list.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(a.name||a.full_name||'')}</td>
                        <td>${esc(a.state||'')}</td>
                        <td>${esc(a.program||'')}</td>
                        <td>${esc(a.decision||'')}</td>
                        <td>${esc(a.interest_level||'')}</td>
                        <td>${esc(a.flags||'')}</td>`;
        tbody.appendChild(tr);
      });
      // Fill assignment applicant select
      const sel = $('#as-app'); sel.innerHTML='';
      list.forEach(a=> sel.appendChild(new Option(a.name||a.full_name||'', a.name||a.full_name||'')));
      filterApplicants();
    }
    function onHostsLoaded(list){
      $('#ov-hosts').textContent = list.length;
      const tbody = $('#hosts-table tbody');
      tbody.innerHTML='';
      list.forEach(h=>{
        const assigned = Number(h.assigned||0);
        const cap = Number(h.capacity||0);
        const left = cap - assigned;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(h.name||'')}</td>
                        <td>${esc(h.building||'')}</td>
                        <td>${esc(h.room||'')}</td>
                        <td>${esc(h.capacity||'')}</td>
                        <td>${assigned}</td>
                        <td>${isNaN(left)?'':left}</td>
                        <td>${esc(h.notes||'')}</td>`;
        tbody.appendChild(tr);
      });
      const sel = $('#as-host'); sel.innerHTML='';
      list.forEach(h=> sel.appendChild(new Option((h.name||'')+ (h.room?` • ${h.room}`:''), h.name||'')));
    }
    function onAssignmentsLoaded(list){
      $('#ov-assignments').textContent = list.length;
      const tbody = $('#assignments-table tbody');
      tbody.innerHTML='';
      list.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(a.applicant||a.app||'')}</td>
                        <td>${esc(a.host||'')}</td>
                        <td>${esc(a.status||'')}</td>`;
        tbody.appendChild(tr);
      });
    }
    function onEngagementLoaded(list){
      const tbody = $('#eng-table tbody');
      tbody.innerHTML='';
      list.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(r.applicant||'')}</td>
                        <td>${esc(r.invite_sent||'')}</td>
                        <td>${esc(r.attending||'')}</td>
                        <td>${esc(r.checked_in||'')}</td>
                        <td>${esc(r.no_show||'')}</td>
                        <td>${esc(r.notes||'')}</td>`;
        tbody.appendChild(tr);
      });
    }
    function onCommsLoaded(list){
      const wrap = $('#comms-summary');
      wrap.innerHTML='';
      const total = list.length;
      const delivered = list.filter(r=> (r.status||'').toLowerCase()==='delivered').length;
      const opened = list.reduce((n,r)=> n + (Number(r.opens)||0), 0);
      const clicked = list.reduce((n,r)=> n + (Number(r.clicks)||0), 0);
      const cards = [
        [`Total messages`, total],
        [`Delivered`, delivered],
        [`Opens (sum)`, opened],
        [`Clicks (sum)`, clicked]
      ];
      for(const [label, val] of cards){
        const c = document.createElement('div');
        c.className='card'; c.style.flex='1 1 200px';
        c.innerHTML = `<strong>${label}</strong><div class="stat">${val}</div>`;
        wrap.appendChild(c);
      }
    }

    // Save assignment (in-memory only)
    $('#as-save').addEventListener('click', ()=>{
      const app = $('#as-app').value; const host = $('#as-host').value; const status = $('#as-status').value;
      if(!app||!host){ toast('Pick an applicant and a host'); return; }
      const rec = {applicant:app, host, status};
      state.assignments.push(rec);
      onAssignmentsLoaded(state.assignments);
      toast('Assignment saved');
    });

    // Exporters
    const exporters = [
      ['#export-app','applicants', 'name,state,program,decision,interest_level,flags'],
      ['#export-host','hosts', 'name,building,room,capacity,assigned,notes'],
      ['#export-asg','assignments', 'applicant,host,status'],
      ['#export-eng','engagement', 'applicant,invite_sent,attending,checked_in,no_show,notes'],
      ['#export-comms','comms', 'timestamp,recipient,campaign,subject,status,opens,clicks']
    ];
    exporters.forEach(([sel,key,headers])=>{
      $(sel).addEventListener('click', ()=>{
        const rows = state[key];
        const csv = toCSV(rows, headers);
        download(csv, `${key}.csv`, 'text/csv');
      });
    });

    $('#dl-templates').addEventListener('click', ()=>{
      exporters.forEach(([,key,headers])=>{
        const csv = headers + '\n';
        download(csv, `${key}-template.csv`, 'text/csv');
      });
      toast('Templates downloaded');
    });

    function toCSV(rows, headers){
      const head = headers.split(',');
      const lines = [headers];
      (rows||[]).forEach(r=>{
        const line = head.map(h=> (r[h]??'').toString().replace(/,/g,' '));
        lines.push(line.join(','));
      });
      return lines.join('\n');
    }

    function download(content, filename, type){
      const blob = new Blob([content], {type});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
    }

    // Brand modal
    const brandModal = $('#brandModal');
    $('#brandBtn').addEventListener('click', ()=> brandModal.showModal());
    $('#brandClose').addEventListener('click', ()=> brandModal.close());

    // Toast
    function toast(msg){
      const wrap = $('#toast');
      const el = document.createElement('div');
      el.className = 't fade-in';
      el.textContent = msg;
      wrap.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 2800);
    }

    // Utils
    function esc(s){ return (s||'').toString().replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    // Basic self-test
    setTimeout(()=>{
      const out = $('#test-output');
      out.textContent = 'OK: UI loaded\nOK: Tabs active\nOK: Exporters wired';
    }, 200);
  </script>
</body>
</html>
